<?php

namespace App\Models;

use PDO;

class Distribution {
    private $db;
    
    public function __construct() {
        $this->db = Database::getInstance()->getConnection();
    }
    
    public function create($donId, $besoinId, $quantite) {
        $stmt = $this->db->prepare("
            INSERT INTO distributions (don_id, besoin_id, quantite) 
            VALUES (?, ?, ?)
        ");
        return $stmt->execute([$donId, $besoinId, $quantite]);
    }
    
    public function getAll() {
        $query = "
            SELECT 
                dist.*,
                d.donateur,
                v.nom as ville_nom,
                tb.nom as type_nom,
                tb.unite
            FROM distributions dist
            JOIN dons d ON dist.don_id = d.id
            JOIN besoins b ON dist.besoin_id = b.id
            JOIN villes v ON b.ville_id = v.id
            JOIN types_besoins tb ON b.type_besoin_id = tb.id
            ORDER BY dist.date_distribution DESC
        ";
        $stmt = $this->db->query($query);
        return $stmt->fetchAll();
    }
    
    public function getByVille($villeId) {
        $query = "
            SELECT 
                dist.*,
                d.donateur,
                tb.nom as type_nom,
                tb.unite,
                tb.prix_unitaire,
                (dist.quantite * tb.prix_unitaire) as valeur
            FROM distributions dist
            JOIN dons d ON dist.don_id = d.id
            JOIN besoins b ON dist.besoin_id = b.id
            JOIN types_besoins tb ON b.type_besoin_id = tb.id
            WHERE b.ville_id = ?
            ORDER BY dist.date_distribution DESC
        ";
        $stmt = $this->db->prepare($query);
        $stmt->execute([$villeId]);
        return $stmt->fetchAll();
    }
    
    public function executerDispatch($mode = 'date') {
        if ($mode === 'proportionnel') {
            return $this->executerDispatchProportionnel();
        }
        
        try {
            $this->db->beginTransaction();
            
            $besoinModel = new Besoin();
            $donModel = new Don();
            
            $besoins = $besoinModel->getBesoinsNonSatisfaits($mode);
            $dons = $donModel->getDonsDisponibles();
            
            $distributionsEffectuees = 0;
            
            foreach ($besoins as $besoin) {
                $quantiteManquante = $besoin['quantite_manquante'];
                
                foreach ($dons as &$don) {
                    if ($don['type_besoin_id'] == $besoin['type_besoin_id'] && $don['quantite_restante'] > 0) {
                        $quantiteADistribuer = min($quantiteManquante, $don['quantite_restante']);
                        
                        $this->create($don['id'], $besoin['id'], $quantiteADistribuer);
                        
                        $besoinModel->updateQuantiteRecue($besoin['id'], $quantiteADistribuer);
                        $besoinModel->recalculerStatut($besoin['id']);
                        $donModel->updateQuantiteRestante($don['id'], $quantiteADistribuer);
                        
                        $don['quantite_restante'] -= $quantiteADistribuer;
                        $quantiteManquante -= $quantiteADistribuer;
                        
                        $distributionsEffectuees++;
                        
                        if ($quantiteManquante <= 0) {
                            break;
                        }
                    }
                }
            }
            
            $this->db->commit();
            return ['success' => true, 'distributions' => $distributionsEffectuees];
            
        } catch (\Exception $e) {
            $this->db->rollBack();
            return ['success' => false, 'error' => $e->getMessage()];
        }
    }
    
    public function executerDispatchProportionnel() {
        try {
            $this->db->beginTransaction();
            
            $besoinModel = new Besoin();
            $donModel = new Don();
            
            // Grouper les besoins par type
            $besoinsParType = [];
            $besoins = $besoinModel->getBesoinsNonSatisfaits('date');
            
            foreach ($besoins as $besoin) {
                $typeId = $besoin['type_besoin_id'];
                if (!isset($besoinsParType[$typeId])) {
                    $besoinsParType[$typeId] = [];
                }
                $besoinsParType[$typeId][] = $besoin;
            }
            
            $distributionsEffectuees = 0;
            
            // Pour chaque type de besoin
            foreach ($besoinsParType as $typeId => $besoinsType) {
                $donsDisponibles = $donModel->getDonsDisponiblesParType($typeId);
                
                if (empty($donsDisponibles)) {
                    continue;
                }
                
                // Calculer le total des dons disponibles pour ce type
                $totalDonsDisponibles = 0;
                foreach ($donsDisponibles as $don) {
                    $totalDonsDisponibles += $don['quantite_restante'];
                }
                
                if ($totalDonsDisponibles <= 0) {
                    continue;
                }
                
                // Calculer le total des besoins pour ce type
                $totalBesoins = 0;
                foreach ($besoinsType as $besoin) {
                    $totalBesoins += $besoin['quantite_manquante'];
                }
                
                // Calculer les proportions
                $allocations = [];
                $totalAlloue = 0;
                $decimales = [];
                
                foreach ($besoinsType as $besoin) {
                    $proportion = $besoin['quantite_manquante'] * $totalDonsDisponibles / $totalBesoins;
                    $partieEntiere = floor($proportion);
                    $decimale = $proportion - $partieEntiere;
                    
                    $allocations[] = [
                        'besoin' => $besoin,
                        'quantite_allouee' => $partieEntiere,
                        'decimale' => $decimale
                    ];
                    
                    $totalAlloue += $partieEntiere;
                    $decimales[] = $decimale;
                }
                
                // Gérer les restes : donner la priorité aux décimales les plus élevées
                $reste = $totalDonsDisponibles - $totalAlloue;
                if ($reste > 0) {
                    // Trier par décimale décroissante
                    usort($allocations, function($a, $b) {
                        return $b['decimale'] <=> $a['decimale'];
                    });
                    
                    for ($i = 0; $i < $reste && $i < count($allocations); $i++) {
                        $allocations[$i]['quantite_allouee']++;
                    }
                }
                
                // Distribuer selon les allocations calculées
                $donsIndex = 0;
                foreach ($allocations as $allocation) {
                    $quantiteRestante = $allocation['quantite_allouee'];
                    $besoin = $allocation['besoin'];
                    
                    while ($quantiteRestante > 0 && $donsIndex < count($donsDisponibles)) {
                        $don = &$donsDisponibles[$donsIndex];
                        
                        if ($don['quantite_restante'] <= 0) {
                            $donsIndex++;
                            continue;
                        }
                        
                        $quantiteADistribuer = min($quantiteRestante, $don['quantite_restante']);
                        
                        $this->create($don['id'], $besoin['id'], $quantiteADistribuer);
                        
                        $besoinModel->updateQuantiteRecue($besoin['id'], $quantiteADistribuer);
                        $besoinModel->recalculerStatut($besoin['id']);
                        $donModel->updateQuantiteRestante($don['id'], $quantiteADistribuer);
                        
                        $don['quantite_restante'] -= $quantiteADistribuer;
                        $quantiteRestante -= $quantiteADistribuer;
                        
                        $distributionsEffectuees++;
                    }
                }
            }
            
            $this->db->commit();
            return ['success' => true, 'distributions' => $distributionsEffectuees];
            
        } catch (\Exception $e) {
            $this->db->rollBack();
            return ['success' => false, 'error' => $e->getMessage()];
        }
    }
